@model IEnumerable<SistemaGestionLlaves.Models.Llave>
@{
    ViewData["Title"] = "Gestión de Llaves";
}

<!-- Page Header -->
<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h2 class="fw-bold" style="color:#0f172a; font-size:1.4rem; margin-bottom:2px;">
            <i class="bi bi-key me-2" style="color:#0369a1;"></i>Gestión de Llaves
        </h2>
        <p class="mb-0" style="color:#64748b; font-size:0.875rem;">Administra las llaves físicas del sistema</p>
    </div>
    <a asp-action="Create" class="btn btn-primary d-flex align-items-center gap-2 px-4 py-2"
       style="background:#0369a1; border-color:#0369a1; border-radius:12px; font-weight:600;">
        <i class="bi bi-plus-lg"></i> Nueva Llave
    </a>
</div>

<!-- Alertas de éxito / error -->
@if (TempData["Success"] != null)
{
    <div class="alert d-flex align-items-center gap-2 mb-4"
         style="background:#dcfce7; border:none; border-radius:12px; color:#166534;">
        <i class="bi bi-check-circle-fill"></i> @TempData["Success"]
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert d-flex align-items-center gap-2 mb-4"
         style="background:#fee2e2; border:none; border-radius:12px; color:#991b1b;">
        <i class="bi bi-exclamation-circle-fill"></i> @TempData["Error"]
    </div>
}

<!-- Filtros -->
<div class="ui-card mb-4">
    <form asp-action="Index" method="get" class="row g-3 align-items-end">
        <div class="col-md-5">
            <label class="form-label fw-600" style="color:#64748b; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em;">Búsqueda</label>
            <div class="input-group" style="border-radius:12px; overflow:hidden;">
                <span class="input-group-text" style="background:#f8fafc; border-color:#e2e8f0; color:#94a3b8;">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" name="busqueda" value="@ViewData["busqueda"]"
                       class="form-control" placeholder="Código o nombre de ambiente..."
                       style="border-color:#e2e8f0; background:#f8fafc;" />
            </div>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-600" style="color:#64748b; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em;">Estado</label>
            <select name="estado" class="form-select" style="border-color:#e2e8f0; background:#f8fafc; border-radius:12px;">
                <option value="">Todos</option>
                <option value="D" selected="@(ViewData["estado"]?.ToString() == "D")">Disponible</option>
                <option value="P" selected="@(ViewData["estado"]?.ToString() == "P")">Prestada</option>
                <option value="R" selected="@(ViewData["estado"]?.ToString() == "R")">Reservada</option>
                <option value="I" selected="@(ViewData["estado"]?.ToString() == "I")">Inactiva</option>
            </select>
        </div>
        <div class="col-md-4 d-flex gap-2">
            <button type="submit" class="btn px-4 py-2" style="background:#0369a1; color:white; border-radius:12px; font-weight:600; border:none;">
                <i class="bi bi-funnel me-1"></i>Filtrar
            </button>
            <a asp-action="Index" class="btn px-4 py-2" style="background:#f1f5f9; color:#64748b; border-radius:12px; font-weight:600; border:none;">
                <i class="bi bi-x-circle me-1"></i>Limpiar
            </a>
        </div>
    </form>
</div>

<!-- Tabla de Llaves -->
<div class="ui-card">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="card-title mb-0">Lista de Llaves</h3>
        <span style="color:#94a3b8; font-size:0.85rem;">@Model.Count() resultado(s)</span>
    </div>

    @if (!Model.Any())
    {
        <div class="text-center py-5" style="color:#94a3b8;">
            <i class="bi bi-key" style="font-size:3rem; display:block; margin-bottom:12px;"></i>
            <p class="mb-0">No se encontraron llaves con los criterios aplicados.</p>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-borderless mb-0">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Ambiente</th>
                        <th>Copias</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th style="text-align:right;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var llave in Model)
                    {
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div style="width:36px; height:36px; background:#e0f2fe; border-radius:10px;
                                                display:flex; align-items:center; justify-content:center; color:#0369a1; font-size:1rem;">
                                        <i class="bi bi-key@(llave.EsMaestra ? "-fill" : "")"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold" style="color:#0f172a;">@llave.Codigo</div>
                                        @if (llave.EsMaestra)
                                        {
                                            <span style="font-size:0.7rem; color:#0369a1; font-weight:600;">MAESTRA</span>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td style="color:#334155;">@llave.Ambiente?.Nombre</td>
                            <td style="color:#334155;">@llave.NumCopias</td>
                            <td>
                                @if (llave.EsMaestra)
                                {
                                    <span class="status-badge" style="background:#ede9fe; color:#6d28d9;">Maestra</span>
                                }
                                else
                                {
                                    <span class="status-badge" style="background:#f1f5f9; color:#64748b;">Normal</span>
                                }
                            </td>
                            <td>
                                @{
                                    var (bg, fg, icono, label) = llave.Estado switch
                                    {
                                        "D" => ("#dcfce7", "#166534", "check-circle", "Disponible"),
                                        "P" => ("#fef3c7", "#92400e", "arrow-left-right", "Prestada"),
                                        "R" => ("#dbeafe", "#1e40af", "calendar-check", "Reservada"),
                                        _   => ("#f1f5f9", "#64748b", "x-circle", "Inactiva")
                                    };
                                }
                                <span class="status-badge" style="background:@bg; color:@fg;">
                                    <i class="bi bi-@icono me-1"></i>@label
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-2 justify-content-end">
                                    <a asp-action="Details" asp-route-id="@llave.IdLlave"
                                       class="btn btn-sm" title="Ver detalles"
                                       style="background:#f1f5f9; color:#0369a1; border-radius:8px; border:none; padding:6px 10px;">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    @if (llave.Estado != "P")
                                    {
                                        <a asp-action="Edit" asp-route-id="@llave.IdLlave"
                                           class="btn btn-sm" title="Editar"
                                           style="background:#e0f2fe; color:#0369a1; border-radius:8px; border:none; padding:6px 10px;">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form asp-action="CambiarEstado" asp-route-id="@llave.IdLlave" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" title="@(llave.Estado == "I" ? "Activar" : "Inactivar")"
                                                    class="btn btn-sm"
                                                    style="background:@(llave.Estado == "I" ? "#dcfce7" : "#fee2e2"); color:@(llave.Estado == "I" ? "#166534" : "#991b1b"); border-radius:8px; border:none; padding:6px 10px;"
                                                    onclick="return confirm('¿Confirmar cambio de estado?')">
                                                <i class="bi bi-@(llave.Estado == "I" ? "toggle-on" : "toggle-off")"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
